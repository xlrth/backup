#include "CPath.h"

#include "CLogger.h"

#ifdef _WIN32
inline constexpr size_t MAX_PATH_LENGTH = __std_fs_max_path;
#else
#   include <linux/limits.h>
inline constexpr size_t MAX_PATH_LENGTH = PATH_MAX; 
#endif

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(const std::filesystem::path& other)
    :
    std::filesystem::path(other)
{
    CheckPathLength();
}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(std::filesystem::path&& other)
    :
    std::filesystem::path(std::move(other))
{
    CheckPathLength();
}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(const std::wstring& s)
    :
    CPath(std::filesystem::path(s))
{}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(std::wstring&& s)
    :
    CPath(std::filesystem::path(std::move(s)))
{}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(const std::string& s)
    :
    CPath(std::filesystem::path(s))
{}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(std::string&& s)
    :
    CPath(std::filesystem::path(std::move(s)))
{}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath::CPath(const char* s)
    :
    CPath(std::filesystem::path(s))
{}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath& CPath::operator /= (const CPath & other)
{
    std::filesystem::path::operator /= (other);
    CheckPathLength();
    return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
CPath& CPath::operator += (const CPath& other)
{
    std::filesystem::path::operator += (other);
    CheckPathLength();
    return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
void CPath::CheckPathLength()
{
    if (native().size() >= MAX_PATH_LENGTH)
    {
        CLogger::GetInstance().LogWarning("path is too long: " + string());
    }
}
